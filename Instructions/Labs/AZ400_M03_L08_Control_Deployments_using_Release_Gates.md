---
lab:
  title: 使用发布入口控制部署
  module: 'Module 03: Design and implement a release strategy'
---

# 使用发布入口控制部署

## 实验室要求

- 本实验室需要使用 Microsoft Edge 或[支持 Azure DevOps 的浏览器](https://docs.microsoft.com/azure/devops/server/compatibility)。

- 设置 Azure DevOps 组织：如果还没有可用于本实验室的 Azure DevOps 组织，请按照[创建组织或项目集合](https://docs.microsoft.com/azure/devops/organizations/accounts/create-organization)中的说明创建一个。

- 标识现有的 Azure 订阅或创建一个新的 Azure 订阅。

- 验证你拥有 Microsoft 帐户或 Microsoft Entra 帐户，该帐户在 Azure 订阅中具有所有者角色并且在与 Azure 订阅关联的 Microsoft Entra 租户中具有全局管理员角色。 有关详细信息，请参阅[使用 Azure 门户列出 Azure 角色分配](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-list-portal)和[在 Azure Active Directory 中查看和分配管理员角色](https://docs.microsoft.com/azure/active-directory/roles/manage-roles-portal)。

## 实验室概述

本实验室涵盖部署入口的配置，并详细介绍如何使用这些配置来控制 Azure Pipelines 的执行。 为说明其实现，你将为 Azure Web 应用配置两个环境下的发布定义。 只有当应用没有阻碍性 bug 时，才会部署到 DevTest 环境，只有当 Azure Monitor 的 Application Insights 中没有活动警报时，才会标记 DevTest 环境完成。

发布管道指定了在各种环境中部署应用程序时的端到端发布过程。 通过使用作业和任务，可以完全自动化到各种环境的部署。 理想情况下，你不需要同时向所有用户公开应用程序的最新更新。 最佳做法是分阶段公开更新，即向部分用户公开，监视其使用情况，并根据最初的一组用户的体验向其他用户公开。

通过审批和入口，你能够在发布中控制部署的开始和完成。 通过手动审批，你可以等待用户批准或拒绝部署。 使用发布入口，可以指定在版本提升到下一个环境之前，应用程序要满足的运行状况条件。 在任何环境部署之前或之后，将自动评估所有这些已指定的入口，直到它们通过或到了你所定义的超时时间并失败。

入口可以从部署前条件或部署后条件面板添加到发布定义的环境中。 可以在环境条件中添加多个入口，以确保发布的所有输入都符合标准。

示例：

- 部署前入口确保在将生成部署到环境之前，工作项或问题管理系统中没有处于活动状态的问题。
- 部署后入口确保在将已部署的应用发布到下一个环境之前，没有来自该应用的监视或事件管理系统的事件。

默认情况下，每个帐户包含 4 种类型的入口。

- 调用 Azure 函数：触发执行 Azure 函数并确保成功完成。
- 查询 Azure Monitor 警报：观察为活动警报配置的 Azure Monitor 预警规则。
- 调用 REST API：调用 REST API 并在返回成功响应后继续。
- 查询工作项：确保查询返回的匹配工作项数量在阈值内。

## 目标

完成本实验室后，你将能够：

- 配置发布管道。
- 配置发布入口。
- 测试发布入口。

## 预计用时：75 分钟

## 说明

### 练习 0：配置实验室先决条件

在本练习中，将设置实验室先决条件。

#### 任务 1：（如果已完成，请跳过此任务）创建和配置团队项目

在此任务中，你将创建一个 eShopOnWeb Azure DevOps 项目，供多个实验室使用。

1. 在实验室计算机上，在浏览器窗口中打开 Azure DevOps 组织。 单击“新建项目”。 将项目命名为 eShopOnWeb，并将其他字段保留默认值。 单击“创建”。

   ![“创建新项目”面板的屏幕截图。](images/create-project.png)

#### 任务 2：（如果已完成，请跳过此任务）导入 eShopOnWeb Git 存储库

在此任务中，你将导入将由多个实验室使用的 eShopOnWeb Git 存储库。

1. 在实验室计算机上，在浏览器窗口中打开 Azure DevOps 组织和以前创建的 eShopOnWeb 项目。 单击“**Repos > 文件**”、“**导入存储库**”。 选择“**导入**”。 在“导入 Git 存储库”窗口中，粘贴以下 URL <https://github.com/MicrosoftLearning/eShopOnWeb.git> 并单击“导入”：

   ![“导入存储库”面板的屏幕截图。](images/import-repo.png)

1. 存储库按以下方式组织：
   - .ado 文件夹包含 Azure DevOps YAML 管道。
   - 设置 .devcontainer 文件夹容器，使用容器（在 VS Code 或 GitHub Codespaces 中本地进行）开发。
   - infra 文件夹包含某些实验室方案中使用的 Bicep 和 ARM 基础结构即代码模板。****
   - .github 文件夹容器 YAML GitHub 工作流定义。
   - src 文件夹包含用于实验室方案的 .NET 8 网站。****

1. 转到“**Repos > 分支**”。
1. 将鼠标指针悬停在主分支上，然后单击列右侧的省略号。
1. 单击“设置为默认分支”。

#### 任务 3：在 Azure DevOps 中使用 YAML 将 CI 管道配置为代码

在此任务中，你将向现有项目添加 YAML 生成定义。

1. 导航回“管道”中心的“管道”窗格 。
1. 在“创建首个管道”窗口中，单击“创建管道” 。

   > 注意：我们将使用向导并基于项目创建新的 YAML 管道定义。

1. 在“你的代码在哪里?”窗格上，单击“Azure Repos Git (YAML)”选项 。
1. 在“选择存储库”窗格中，单击“eShopOnWeb”。
1. 在“配置管道”窗格上，向下滚动并选择“现有 Azure Pipelines YAML 文件” 。
1. 在“选择现有 YAML 文件”边栏选项卡中，指定以下参数：
   - 分支：main
   - 路径：.ado/eshoponweb-ci.yml
1. 单击“继续”保存这些设置。
1. 在“查看管道 YAML”屏幕中，单击“运行”以启动生成管道过程。
1. 等待生成管道过程成功完成。 忽略有关源代码本身的任何警告，因为这些警告与本实验室练习无关。

   > **注意**：YAML 文件中的每项任务都可供查看，包括任何警告和错误。

1. 管道将采用基于项目名称的名称。 让我们重命名它，以便更好地识别管道。 转到“**管道 > 管道**”，然后单击最近创建的管道。 单击省略号和“**重命名/移动**”选项。 将其命名为 **`eshoponweb-ci`**，然后单击“**保存**”。

### 练习 1：为发布管道创建必要的 Azure 资源

#### 任务 1：创建两个 Azure Web 应用

在此任务中，你将创建两个分别代表 DevTest 和“生产”环境的 Azure Web 应用，你将通过 Azure Pipelines 将应用程序部署到其中 。

1. 从实验室计算机启动 Web 浏览器，导航到 [**Azure 门户**](https://portal.azure.com)，并使用用户帐户登录，该帐户在本实验室将使用的 Azure 订阅中具有所有者角色，并在与此订阅关联的 Microsoft Entra 租户中具有全局管理员角色。
1. 在 Azure 门户中，单击页面顶部搜索文本框右侧的 Cloud Shell 图标。
1. 如果系统提示选择“Bash”或“PowerShell”，请选择“Bash”。

   > **注意**：如果这是第一次启动 Cloud Shell，并看到“未装载任何存储”消息，请选择在本实验室中使用的订阅，然后选择“创建存储”  。

1. 在 Cloud Shell 窗格中的 Bash 提示符下，运行以下命令以创建资源组（将 `<region>` 变量占位符替换为将托管两个 Azure Web 应用的 Azure 区域的名称，例如“westeurope”、“centralus”或你选择的任何其他可用区域）：

   > **注意**：可以通过运行以下命令找到可能的位置，使用 `<region>` 上的“Name”：`az account list-locations -o table`

   ```bash
   REGION='<region>'
   RESOURCEGROUPNAME='az400m03l08-RG'
   az group create -n $RESOURCEGROUPNAME -l $REGION
   ```

1. 创建应用服务计划

   ```bash
   SERVICEPLANNAME='az400m03l08-sp1'
   az appservice plan create -g $RESOURCEGROUPNAME -n $SERVICEPLANNAME --sku S1
   ```

1. 使用唯一的应用名称创建两个 Web 应用。

   ```bash
   SUFFIX=$RANDOM$RANDOM
   az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n RGATES$SUFFIX-DevTest
   az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n RGATES$SUFFIX-Prod
   ```

   > 注意：记录 DevTest Web 应用的名称。 本实验室中稍后会用到它。

1. 请等待 Web 应用服务器资源预配过程完成，然后关闭 Cloud Shell 窗格。

#### 任务 2：配置 Application Insights 资源

1. 在 Azure 门户中，使用页面顶部的“**搜索资源、服务和文档**”文本框搜索“**`Application Insights`**”，然后在结果列表中选择“**Application Insights**”。
1. 在“Application Insights”边栏选项卡上，选择“+ 创建” 。
1. 在“**Application Insights**”边栏选项卡上的“**基本信息**”选项卡上，指定以下设置（其他设置保留默认值）：

   | 设置        | 值                                                                                 |
   | -------------- | ------------------------------------------------------------------------------------- |
   | 资源组 | **az400m03l08-RG**                                                                    |
   | 名称           | 在上一个任务中记录的 DevTest Web 应用的名称                     |
   | 区域         | 之前在上一个任务中部署 Web 应用的同一 Azure 区域 |

1. 依次单击“查看 + 创建”、“创建”。
1. 等待预配过程完成。
1. 在 Azure 门户中，导航到在上一任务中创建的资源组“**az400m03l08-RG**”。
1. 在资源列表中，单击 DevTest Web 应用。
1. 在 **DevTest** Web 应用页中，在左侧垂直菜单中的“**监视**”部分，单击“**Application Insights**”。
1. 在“Application Insights”边栏选项卡上，单击“打开 Application Insights” 。
1. 在“更改资源”部分中，单击“选择现有资源”选项，在现有资源列表中，选择新创建的 Application Insight 资源，单击“应用”，提示确认后单击“是”   。
1. 等待更改生效。

   > **注意**：你将在此处创建监视器警报，并将在本实验室的后续部分使用。

1. 在 Web 应用的同一“设置” / “Application Insights”菜单选项中，选择“查看 Application Insight 数据”。 这会将你重定向到 Azure 门户中的 Application Insights 边栏选项卡。
1. 在 Application Insights 资源边栏选项卡上的“监视”部分中，单击“警报”，然后单击“创建”>“警报规则”  。
1. 在“**创建警报规则**”边栏选项卡上的“**条件**”部分，单击**查看所有信号**链接，键入“**请求**”。 从结果列表中，选择“失败的请求数”。
1. 在“创建警报规则”边栏选项卡上的“条件”部分中，将“阈值”的设置保留为“静态”，验证其他默认设置，如下所示：

   - 聚合类型：计数
   - 运算符：大于
   - 单位：计数

1. 在“阈值”文本框中，键入 0，然后单击“下一步: 操作”。 不要在“操作”设置边栏选项卡中进行任何更改，并在“详细信息”部分下定义以下参数：

   | 设置                                        | 值                            |
   | ---------------------------------------------- | -------------------------------- |
   | 严重性                                       | **2- 警告**                   |
   | 警报规则名称                                | **RGATESDevTest_FailedRequests** |
   | 高级选项：自动解决警报 | **已清除**                      |

   > **注意**：指标警报规则最多可能需要 10 分钟才能激活。

   > **注意**：你可以根据不同的指标创建多个警报规则，例如可用性小于 99%、服务器响应时间大于 5 秒或服务器异常大于 0 个

1. 单击“查看 + 创建”确认创建警报规则，然后单击“创建”再次确认。 等待警报规则成功创建。

### 练习 2：配置发布管道

在本练习中，你将配置发布管道。

#### 任务 1：设置发布任务

在此任务中，你会将发布任务设置为发布管道的一部分。

1. 在 Azure DevOps 门户中的 eShopOnWeb 项目中，在垂直导航窗格中，选择“管道”，然后在“管道”部分中单击“发布”。
1. 单击“新建管道”。
1. 在“选择模板”窗口中，在模板的“特别推荐”列表下选择“Azure 应用服务部署（将应用程序部署到 Azure 应用服务。 从 Windows、Linux、容器、函数应用或 WebJobs 中选择）。
1. 单击“应用”。
1. 在显示的“**阶段**”窗口中，将默认的“阶段 1”阶段名称更新为“**`DevTest`**”。 使用“X”按钮关闭弹出窗口。 现在，你位于发布管道的图形编辑器中，它显示了 DevTest 阶段。
1. 在页面顶部，将当前管道从“**新建发布管道**”重命名为“**`eshoponweb-cd`**”。
1. 将鼠标悬停在 DevTest 阶段上，然后单击“克隆”按钮，将 DevTest 阶段复制到其他阶段。 将此阶段命名为“**`Production`**”。

   > 注意：此管道现在包含两个阶段，即“DevTest”和“生产”。

1. 在“管道”选项卡上，选择“添加项目”矩形，然后在“源(生成管道)”字段中选择“eshoponweb-ci”。 单击“添加”以确认选择项目。
1. 在“项目”矩形中，请注意持续部署触发器（闪电） 。 单击它可打开“持续部署触发器”设置。 单击“已禁用”切换开关并启用它。 将所有其他设置保留为默认值，并单击右上角的 x 标记关闭“持续部署触发器”窗格 。
1. 在“DevTest 环境”**** 阶段中，单击“第 1 项作业，第 1 个任务”**** 标签，然后查看此阶段中的任务 。

   > 注意：DevTest 环境有 1 个任务，它分别将工件包发布到 Azure Web 应用。

1. 在“所有管道 > eshoponweb-cd”窗格上，确保已选择“DevTest”阶段。 在“Azure 订阅”下拉列表中，选择你的 Azure 订阅，然后单击“授权” 。 如果出现提示，请使用在 Azure 订阅中具有所有者角色的用户帐户进行身份验证。
1. 确认“应用类型”设置为“Windows 上的 Web 应用”。 接下来，在“应用服务名称”下拉列表中，选择“DevTest”Web 应用的名称。
1. 选择“部署 Azure 应用服务”任务。 在“包或文件夹”字段中，将“$(System.DefaultWorkingDirectory)/\*\*/\*.zip”的默认值更新为“$(System.DefaultWorkingDirectory)/\*\*/Web.zip”**

   > **备注**：请注意“任务”选项卡旁边的感叹号。这符合预期，因为我们需要配置生产阶段的设置。

1. 打开“应用程序和配置设置”窗格****，然后在“应用设置”**** 框中输入 `-UseOnlyInMemoryDatabase true -ASPNETCORE_ENVIRONMENT Development`。

1. 在“所有管道” > “eshoponweb-cd”**** 窗格中，导航到“管道”**** 选项卡，这次在“生产”**** 阶段中单击“第 1 项作业，第 1 个任务”**** 标签。 与之前的 DevTest 阶段类似，完成管道设置。 在“任务”选项卡/生产部署过程下的“Azure 订阅”下拉列表中，选择“可用 Azure 服务连接”下显示的用于“DevTest 环境”阶段的 Azure 订阅，因为我们在授权订阅使用之前就已经创建了服务连接。
1. 在“应用服务名称”下拉列表中，选择 Prod Web 应用的名称 。
1. 选择“部署 Azure 应用服务”任务。 在“包或文件夹”字段中，将“$(System.DefaultWorkingDirectory)/\*\*/\*.zip”的默认值更新为“$(System.DefaultWorkingDirectory)/\*\*/Web.zip”**
1. 打开“应用程序和配置设置”窗格****，然后在“应用设置”**** 框中输入 `-UseOnlyInMemoryDatabase true -ASPNETCORE_ENVIRONMENT Development`。
1. 在“所有管道 > eshoponweb-cd”窗格上，单击“保存”，然后在“保存”对话框中，单击“确定”   。

   现已成功配置发布管道。

1. 在显示“eShopOnWeb”项目的浏览器窗口中，在垂直导航窗格的“管道”部分，单击“管道”。
1. 在“管道”窗格上，单击代表 eshoponweb-ci 生成管道的条目，然后单击“运行管道”  。
1. 在“运行管道”窗格上，接受默认设置，然后单击“运行”以触发管道 。 等待生成管道完成。

   > **注意**：生成成功后，将自动触发发布，并将应用程序部署到两个环境中。 生成管道成功完成后，验证发布操作。

1. 在垂直导航窗格的“管道”部分中，单击“发布”，然后在“eshoponweb-cd”窗格中，单击代表最新发布的条目。
1. 在“eshoponweb-cd > Release-1”边栏选项卡上，跟踪发布进度并验证这两个 Web 应用的部署是否成功完成。
1. 切换到 Azure 门户界面，导航到资源组 **az400m03l08-RG**，在资源列表中，单击“**DevTest**”Web 应用，在 Web 应用边栏上，单击“**浏览**”，并验证网页（电子商务网站）是否在新的 Web 浏览器标签页中成功加载。
1. 切换回 Azure 门户界面，这次导航到资源组 **az400m03l08-RG**，在资源列表中，单击“**生产**”Web 应用，在 Web 应用边栏选项卡上，单击“**浏览**”，并验证网页是否在新的 Web 浏览器标签页中成功加载。
1. 关闭显示 EShopOnWeb 网站的 Web 浏览器标签页。

   > **注意**：现在，应用程序已经配置了 CI/CD。 在下一个练习中，我们将设置质量入口作为更高级发布管道的一部分。

### 练习 3：配置发布入口

在本练习中，你将在发布管道中设置质量入口。

#### 任务 1：配置部署前入口以获得审批

在此任务中，你将配置部署前入口。

1. 切换到显示 Azure DevOps 门户的 Web 浏览器窗口，然后打开 **eShopOnWeb** 项目。 在垂直导航窗格中的“管道”部分中，单击“发布”，然后在“eshoponweb-cd”窗格中，单击“编辑”。
1. 在“所有管道”>“eshoponweb-cd”窗格上，在代表“DevTest 环境”阶段的矩形的左边缘上，单击代表“部署前条件”的椭圆形。
1. 在“部署前条件”窗格上，将“部署前审批”滑块设置为“启用”，然后在“审批者”文本框中，键入并选择你的 Azure DevOps 帐户名称   。

   > 注意：在实际场景中，这应该是 DevOps 团队名称别名，而不是你自己的名称。

1. 保存预批准设置并关闭弹出窗口。
1. 单击“创建发布”，然后按弹出窗口中的“创建”按钮进行确认。
1. 请注意绿色确认消息，指出“Release-2”已创建。 单击“Release-2”链接导航到其详细信息。
1. 请注意，“DevTest”阶段处于“待审批”状态。 单击“批准”按钮。 这会再次触发 DevTest 阶段。

#### 任务 2：为 Azure Monitor 配置部署后入口

在此任务中，你将启用 DevTest 环境的部署后入口。

1. 返回“所有管道”>“eshoponweb-cd”窗格，在代表“DevTest 环境”阶段的矩形的右边缘上，单击代表“部署后条件”的椭圆形。
1. 在“部署后条件”窗格中，将“入口”滑块设置为“启用”，单击“+ 添加”，然后单击弹出菜单中的“查询 Azure Monitor 警报”    。
1. 在“**部署后条件**”窗格中的“**查询 Azure Monitor 警报**”部分的“**Azure 订阅**”下拉列表中，选择代表连接到 Azure 订阅的“**服务连接**”条目，并在“**资源组**”下拉列表中，选择 **az400m03l08-RG** 条目。
1. 在“部署后条件”窗格上，展开“高级”部分并配置以下选项：

   - 筛选器类型：无
   - 严重性：Sev0、Sev1、Sev2、Sev3、Sev4
   - 时间范围：过去一小时
   - 警报状态：已确认、新建
   - 监视条件：已触发

1. 在“部署后条件”窗格上，展开“评估选项”并配置以下选项 ：

   - 将“重新评估入口的间隔时间”值设置为“5 分钟” 。
   - 将“入口失败后超时时间”值设置为“8 分钟” 。
   - 选择“在成功的入口上，请求批准”选项。

   > **注意**：采样间隔和超时一起作用，确保入口以适当的间隔调用函数，如果在超时周期同一采样间隔内未成功执行函数，则将拒绝部署。

1. 单击右上角的 x 标记，关闭“部署后条件”窗格 。
1. 返回“所有管道 > eshoponweb-cd”窗格，单击“保存”，然后在“保存”对话框中，单击“确定”   。

### 练习 4：测试发布入口

在本练习中，你将通过更新应用程序来测试发布入口，这将触发部署。

#### 任务 1：添加发布入口后更新和部署应用程序

在此任务中，你将首先为 DevTest Web 应用生成一些警报，然后跟踪启用了发布入口的发布过程。

1. 在 Azure 门户中，浏览到之前部署的 DevTest Web 应用资源。
1. 在“概述”窗格中，注意到显示 Web 应用程序的超链接的“URL”字段。 单击此链接会将你重定向到浏览器中的 eShopOnWeb Web 应用程序。
1. 若要模拟失败的请求，请将 /discount 添加到 URL 中，这将导致出现错误消息，因为该页面不存在。 多次刷新此页面以生成多个事件。
1. 在 Azure 门户的“搜索资源、服务和文档”字段中，输入 **`Application Insights`**，并选择在上一练习中创建的 **DevTest-AppInsights** 资源。 接下来，导航到“警报”。
1. 结果列表中应至少有 **1 个**新警报，具有“**严重性 2**”，输入 **`Alerts`** 可打开 Azure Monitor 的警报服务。
1. 请注意，列表中应至少有“1 个失败的警报”显示为“严重性 2 - 警告”。 在上一练习中验证不存在的网站 URL 地址时，会触发此警报。

   > 注意：如果尚未显示警报，请再等待几分钟。

1. 返回到 Azure DevOps 门户，打开“eShopOnWeb”项目。**** 导航到“管道”，选择“发布”，然后选择“eshoponweb-cd”。
1. 单击“创建发布”按钮。
1. 等待发布管道启动，并批准 DevTest 阶段发布操作。
1. 等待 DevTest 发布阶段成功完成。 请注意“**部署后入口**”如何切换到“**评估入口**”状态。 单击“评估入口”图标。
1. 对于“查询 Azure Monitor 警报”，请注意初始失败状态。
1. 让发布管道在接下来的 5 分钟内处于挂起状态。 5 分钟过后，请注意第 2 次评估再次失败。
1. 这是预期行为，因为有针对 DevTest Web 应用触发的 Application Insights 警报。

   > **注意**：由于异常触发了警报，因此“查询 Azure Monitor”入口将失败。 反过来，这将阻止部署到“生产”环境。

1. 等待两分钟，然后再次验证发布入口的状态。 检查完初始发布入口几分钟后，由于初始 Application Insights 警报被触发且操作变为“已触发”，它应会产生成功的发布入口，从而允许部署生产发布阶段。

   > 注意：如果入口发生故障，请关闭警报。

   > [!IMPORTANT]
   > 请记住删除在 Azure 门户中创建的资源，以避免不必要的费用。

## 审阅

在本实验室中，你配置了发布管道，然后配置并测试了发布入口。
